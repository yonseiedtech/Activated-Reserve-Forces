generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// ─── 부대 (참조 테이블) ───
model Unit {
  id          String   @id @default(cuid())
  name        String   @unique  // "00사단 00연대"
  description String?
  createdAt   DateTime @default(now())
}

// ─── 사용자 (관리자/행정담당자/급식담당자/대상자) ───
model User {
  id        String   @id @default(cuid())
  name      String
  username  String   @unique
  email     String?
  password  String
  role      String   @default("RESERVIST") // ADMIN, MANAGER, COOK, RESERVIST
  phone     String?
  rank      String?  // 계급 (대상자용)
  serviceNumber String? // 군번 (대상자용)
  unit      String?  // 소속부대
  position  String?  // 직책 (예: "상비예비군")
  birthDate DateTime? // 생년월일
  branch       String?  // 병과 (보병, 포병, 공병 등)
  warBattalion String?  // 전시부대 소속1 (대대)
  warCompany   String?  // 전시부대 소속2 (중대)
  warPlatoon   String?  // 전시부대 소속3 (소대/지휘부)
  warPosition  String?  // 전시직책
  uniqueNumber String?  @unique  // 관리자 수동 할당 고유번호
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계
  batchUsers           BatchUser[]
  trainingsAsInstructor Training[]       @relation("InstructorTrainings")
  attendances          Attendance[]
  commutingRecords     CommutingRecord[]
  sentMessages         Message[]         @relation("SentMessages")
  receivedMessages     Message[]         @relation("ReceivedMessages")
  notifications        Notification[]
  surveyResponses      SurveyResponse[]
  pushSubscriptions    PushSubscription[]
  mobileIdCard         MobileIdCard?
  approvedIdCards      MobileIdCard[]     @relation("ApprovedByUser")
  transportAllowances  UserTransportAllowance[]
}

// ─── User-Batch M:N 조인 테이블 ───
model BatchUser {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  batchId   String
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  @@unique([userId, batchId])
}

// ─── 차수 (훈련 기수) ───
model Batch {
  id        String   @id @default(cuid())
  name      String   // 예: "2026년 1차수"
  year      Int
  number    Int      // 차수 번호
  startDate DateTime
  endDate   DateTime
  status    String   @default("PLANNED") // PLANNED, ACTIVE, COMPLETED
  createdAt DateTime @default(now())

  location       String?  // 훈련 장소
  requiredHours  Float?   // 훈련 부과 시간 (예: 40)

  batchUsers          BatchUser[]
  trainings           Training[]
  meals               Meal[]
  paymentProcesses    PaymentProcess[]
  transportAllowances UserTransportAllowance[]
  refundProcess       RefundProcess?
}

// ─── 훈련 일정 ───
model Training {
  id           String   @id @default(cuid())
  title        String
  type         String   // 사격, 화생방, 전술, 체력, 정신교육 등
  date         DateTime
  startTime    String?  // "09:00"
  endTime      String?  // "17:00"
  location     String?
  description  String?
  batchId      String
  batch        Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  instructorId String?
  instructor   User?    @relation("InstructorTrainings", fields: [instructorId], references: [id])
  createdAt    DateTime @default(now())

  attendances  Attendance[]
  compensation TrainingCompensation?
}

// ─── 출석 (참석/불참) ───
model Attendance {
  id          String   @id @default(cuid())
  trainingId  String
  training    Training @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  status            String    @default("PENDING") // PRESENT, ABSENT, PENDING
  reason            String?   // 불참 사유
  expectedConfirmAt DateTime? // 미정일 때 확정 예정 시점
  earlyLeaveTime    String?   // 조기퇴소 시간 (예: "10:30")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([trainingId, userId])
}

// ─── 출퇴근 기록 (GPS 기반) ───
model CommutingRecord {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  date        DateTime
  checkInAt   DateTime?
  checkOutAt  DateTime?
  checkInLat  Float?   // GPS 위도 (관리자만 열람)
  checkInLng  Float?   // GPS 경도
  checkOutLat Float?
  checkOutLng Float?
  isManual    Boolean  @default(false) // 관리자 수기 입력 여부
  note        String?  // 비고
  createdAt   DateTime @default(now())

  @@unique([userId, date])
}

// ─── GPS 기준 위치 (위병소/훈련장) ───
model GpsLocation {
  id        String @id @default(cuid())
  name      String // 예: "00부대 위병소"
  latitude  Float
  longitude Float
  radius    Int    @default(200) // 허용 반경(미터)
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
}

// ─── 식사 관리 ───
model Meal {
  id        String   @id @default(cuid())
  batchId   String
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  date      DateTime
  type      String   // BREAKFAST, LUNCH, DINNER
  menuInfo  String?  // 메뉴 내용
  menuFile  String?  // 메뉴 파일 경로
  headcount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([batchId, date, type])
}

// ─── 훈련비 입금 프로세스 (차수당 1개, 자동 생성) ───
model PaymentProcess {
  id        String   @id @default(cuid())
  batchId   String   @unique
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  title     String   // 예: "2026년 1차수 훈련비"
  bankInfo  String?  // 은행/계좌 정보
  status    String   @default("DOC_DRAFT") // DOC_DRAFT → DOC_APPROVED → CMS_DRAFT → CMS_APPROVED
  docDraftAt    DateTime? // 공문 상신 일시
  docApprovedAt DateTime? // 공문 결재완료
  cmsDraftAt    DateTime? // CMS 결재 상신
  cmsApprovedAt DateTime? // 결재완료 입금
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── 쪽지 ───
model Message {
  id         String   @id @default(cuid())
  senderId   String
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  title      String
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
}

// ─── 알림 ───
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  content   String
  type      String   @default("GENERAL") // GENERAL, TRAINING, PAYMENT, NOTICE
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

// ─── 푸시 구독 정보 ───
model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  @@unique([userId, endpoint])
}

// ─── 공지사항 ───
model Notice {
  id        String   @id @default(cuid())
  title     String
  content   String
  isPinned  Boolean  @default(false)
  filePath  String?
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reads     NoticeRead[]
}

// ─── 공지 읽음 추적 ───
model NoticeRead {
  id        String   @id @default(cuid())
  noticeId  String
  notice    Notice   @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  userId    String
  readAt    DateTime @default(now())

  @@unique([noticeId, userId])
}

// ─── 설문조사 ───
model Survey {
  id        String   @id @default(cuid())
  title     String
  description String?
  questions String   // JSON 형태로 질문 저장
  isActive  Boolean  @default(true)
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime @default(now())

  responses SurveyResponse[]
}

model SurveyResponse {
  id        String   @id @default(cuid())
  surveyId  String
  survey    Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  answers   String   // JSON 형태로 답변 저장
  createdAt DateTime @default(now())

  @@unique([surveyId, userId])
}

// ─── 훈련별 보상비 (자동 계산) ───
model TrainingCompensation {
  id             String   @id @default(cuid())
  trainingId     String   @unique
  training       Training @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  trainingHours  Float    // 실훈련 시간 (점심시간 제외)
  isWeekend      Boolean  // 주말 여부
  dailyRate      Int      // 계산된 보상비 (원)
  overrideRate   Int?     // 관리자 수동 오버라이드 금액
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// ─── 인원별 교통비 ───
model UserTransportAllowance {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  batchId   String
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  amount    Int      // 교통비 금액 (원)
  address   String?  // 기준 주소 (참고용)
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, batchId])
}

// ─── 환수 프로세스 ───
model RefundProcess {
  id                  String    @id @default(cuid())
  batchId             String    @unique
  batch               Batch     @relation(fields: [batchId], references: [id], onDelete: Cascade)
  status              String    @default("REFUND_REQUESTED")
  reason              String?
  compensationRefund  Int       @default(0)
  transportRefund     Int       @default(0)
  refundRequestedAt   DateTime?
  depositConfirmedAt  DateTime?
  refundCompletedAt   DateTime?
  note                String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

// ─── 모바일 신분증 ───
model MobileIdCard {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id])
  uniqueNumber  String    @unique  // 고유번호 (예: "RES-2026-00001")
  validFrom     DateTime           // 유효기간 시작
  validUntil    DateTime           // 유효기간 종료
  isApproved    Boolean   @default(false)
  approvedAt    DateTime?
  approvedById  String?
  approvedBy    User?     @relation("ApprovedByUser", fields: [approvedById], references: [id])
  rejectedAt    DateTime?
  rejectReason  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}
